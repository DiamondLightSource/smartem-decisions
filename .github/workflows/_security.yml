on:
  workflow_call:

jobs:
  detect-secrets:
    runs-on: ubuntu-latest
    name: Secrets Scanning
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Full history for comprehensive scanning
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        cache: 'pip'
    
    - name: Install detect-secrets
      run: |
        python -m pip install --upgrade pip
        pip install detect-secrets
    
    - name: Verify baseline exists
      run: |
        if [ ! -f .secrets.baseline ]; then
          echo "âŒ .secrets.baseline not found!"
          echo "This likely means the pre-commit setup is incomplete."
          exit 1
        fi
        echo "âœ… Found .secrets.baseline"
    
    - name: Run detect-secrets scan
      run: |
        echo "ğŸ” Scanning for secrets..."
        detect-secrets scan \
          --baseline .secrets.baseline \
          --exclude-files '^docs/assets/' \
          --exclude-files '^build/' \
          --exclude-files '^dist/' \
          --exclude-files '.*\.lock$' \
          --exclude-files '.*migrations/versions/.*\.py$' \
          --force-use-all-plugins
    
    - name: Audit baseline for unaudited secrets
      run: |
        echo "ğŸ” Auditing secrets baseline..."
        
        # Check if baseline contains any unaudited secrets (null values)
        if grep -q '"is_secret": null' .secrets.baseline; then
          echo "âŒ Found unaudited secrets in baseline!"
          echo "Please run: detect-secrets audit .secrets.baseline"
          echo "Review and mark each finding as true/false positive"
          detect-secrets audit .secrets.baseline --report
          exit 1
        else
          echo "âœ… All secrets in baseline have been audited"
          detect-secrets audit .secrets.baseline --report
        fi
    
    - name: Check for new secrets in recent commits
      if: github.event_name == 'pull_request'
      run: |
        echo "ğŸ†• Checking for new secrets in PR..."
        # Get the diff and scan it for secrets
        git diff origin/main...HEAD | detect-secrets scan --baseline .secrets.baseline --stdin --force-use-all-plugins
    
    - name: Upload scan results
      uses: actions/upload-artifact@v4
      if: failure()
      with:
        name: secrets-scan-results
        path: |
          .secrets.baseline
        retention-days: 30
