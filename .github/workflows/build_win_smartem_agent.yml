name: Validate SmartEM Agent Windows Build

on:
  pull_request:
    paths:
      - 'src/smartem_agent/**'
      - 'src/smartem_common/**'
      - 'src/smartem_backend/api_client.py'
      - '.github/workflows/build_win_smartem_agent.yml'

jobs:
  build:
    name: Build Windows executable (validation)
    runs-on: windows-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          sparse-checkout: |
            src
            pyproject.toml
            README.md

      - name: Set up Python 3.12
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller
          pip install .[agent]

      - name: Build SmartEM Agent with PyInstaller
        run: >-
          pyinstaller --onefile
          --name smartem-agent
          --paths src
          --hidden-import watchdog.observers.polling
          --hidden-import watchdog.observers.winapi
          --hidden-import smartem_common.schemas
          --hidden-import smartem_backend.api_client
          src/smartem_agent/__main__.py

      - name: Smoke test - help
        run: |
          ./dist/smartem-agent.exe --help
          if ($LASTEXITCODE -ne 0) { throw "SmartEM Agent smoke test failed" }

      - name: Smoke test - watch help
        run: |
          ./dist/smartem-agent.exe watch --help
          if ($LASTEXITCODE -ne 0) { throw "SmartEM Agent watch help smoke test failed" }
