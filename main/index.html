
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>SmartEM Decisions &#8212; smartem-decisions 0.1.dev239+g2afd0fc documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "";
  </script>
  <!--
    this give us a css class that will be invisible only if js is disabled
  -->
  <noscript>
    <style>
      .pst-js-only { display: none !important; }

    </style>
  </noscript>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8878045cc6db502f8baf" rel="stylesheet" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
    <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-design.min.css?v=95c83b7e" />
  
  <!-- So that users can add custom icons -->
  <script src="_static/scripts/fontawesome.js?digest=8878045cc6db502f8baf"></script>
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf" />

    <script src="_static/documentation_options.js?v=ec23ece8"></script>
    <script src="_static/doctools.js?v=9bcbadda"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=30646c52"></script>
    <script src="_static/design-tabs.js?v=f930bc37"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'index';</script>
    <script>
        DOCUMENTATION_OPTIONS.theme_version = '0.16.1';
        DOCUMENTATION_OPTIONS.theme_switcher_json_url = 'https://DiamondLightSource.github.io/smartem-decisions/switcher.json';
        DOCUMENTATION_OPTIONS.theme_switcher_version_match = 'main';
        DOCUMENTATION_OPTIONS.show_version_warning_banner =
            false;
        </script>
    <link rel="icon" href="_static/dls-logo.svg"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Tutorials" href="tutorials.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  <meta name="docsearch:version" content="main" />
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <div id="pst-skip-link" class="skip-link d-print-none"><a href="#main-content">Skip to main content</a></div>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>Back to top</button>

  
  <dialog id="pst-search-dialog">
    
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form>
  </dialog>

  <div class="pst-async-banner-revealer d-none">
  <aside id="bd-header-version-warning" class="d-none d-print-none" aria-label="Version warning"></aside>
</div>

  
    <header class="bd-header navbar navbar-expand-lg bd-navbar d-print-none">
<div class="bd-header__inner bd-page-width">
  <button class="pst-navbar-icon sidebar-toggle primary-toggle" aria-label="Site navigation">
    <span class="fa-solid fa-bars"></span>
  </button>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  
    
  

<a class="navbar-brand logo" href="#">
  
  
  
  
  
    
    
      
    
    
    <img src="_static/dls-logo.svg" class="logo__image only-light" alt=""/>
    <img src="_static/dls-logo.svg" class="logo__image only-dark pst-js-only" alt=""/>
  
  
    <p class="title logo__title">smartem-decisions</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
        </div>
      
      
        <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DiamondLightSource/smartem-decisions" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/smartem-decisions" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
      
        <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-2"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-2"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-2"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-2">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

<button class="btn search-button-field search-button__button pst-js-only" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
 <i class="fa-solid fa-magnifying-glass"></i>
 <span class="search-button__default-text">Search</span>
 <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
</button>
    </div>
  

  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
        
      
      <dialog id="pst-primary-sidebar-modal"></dialog>
      <div id="pst-primary-sidebar" class="bd-sidebar-primary bd-sidebar hide-on-wide">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          
          
            <div class="navbar-item">
<nav>
  <ul class="bd-navbar-elements navbar-nav">
    
<li class="nav-item ">
  <a class="nav-link nav-internal" href="tutorials.html">
    Tutorials
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="how-to.html">
    How-to Guides
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="explanations.html">
    Explanations
  </a>
</li>


<li class="nav-item ">
  <a class="nav-link nav-internal" href="reference.html">
    Reference
  </a>
</li>

  </ul>
</nav></div>
          
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<button class="btn btn-sm nav-link pst-navbar-icon theme-switch-button pst-js-only" aria-label="Color mode" data-bs-title="Color mode"  data-bs-placement="bottom" data-bs-toggle="tooltip">
  <i class="theme-switch fa-solid fa-sun                fa-lg" data-mode="light" title="Light"></i>
  <i class="theme-switch fa-solid fa-moon               fa-lg" data-mode="dark"  title="Dark"></i>
  <i class="theme-switch fa-solid fa-circle-half-stroke fa-lg" data-mode="auto"  title="System Settings"></i>
</button></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/DiamondLightSource/smartem-decisions" title="GitHub" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/smartem-decisions" title="PyPI" class="nav-link pst-navbar-icon" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><i class="fas fa-cube fa-lg" aria-hidden="true"></i>
            <span class="sr-only">PyPI</span></a>
        </li>
</ul></div>
        
          <div class="navbar-item">
<div class="version-switcher__container dropdown pst-js-only">
  <button id="pst-version-switcher-button-3"
    type="button"
    class="version-switcher__button btn btn-sm dropdown-toggle"
    data-bs-toggle="dropdown"
    aria-haspopup="listbox"
    aria-controls="pst-version-switcher-list-3"
    aria-label="Version switcher list"
  >
    Choose version  <!-- this text may get changed later by javascript -->
    <span class="caret"></span>
  </button>
  <div id="pst-version-switcher-list-3"
    class="version-switcher__menu dropdown-menu list-group-flush py-0"
    role="listbox" aria-labelledby="pst-version-switcher-button-3">
    <!-- dropdown will be populated by javascript on page load -->
  </div>
</div></div>
        
      </div>
    
  </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
      <div class="sidebar-primary-item">
<div id="ethical-ad-placement"
      class="flat"
      data-ea-publisher="readthedocs"
      data-ea-type="readthedocs-sidebar"
      data-ea-manual="true">
</div></div>
  </div>


      </div>
      
      <main id="main-content" class="bd-main" role="main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article d-print-none"></div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <p><a class="reference external" href="https://github.com/DiamondLightSource/smartem-decisions/actions/workflows/ci.yml"><img alt="CI" src="https://github.com/DiamondLightSource/smartem-decisions/actions/workflows/ci.yml/badge.svg" /></a>
<a class="reference external" href="https://codecov.io/gh/DiamondLightSource/smartem-decisions"><img alt="Coverage" src="https://codecov.io/gh/DiamondLightSource/smartem-decisions/branch/main/graph/badge.svg" /></a>
<a class="reference external" href="https://opensource.org/licenses/Apache-2.0"><img alt="License" src="https://img.shields.io/badge/License-Apache%202.0-blue.svg" /></a></p>
<section id="smartem-decisions">
<h1>SmartEM Decisions<a class="headerlink" href="#smartem-decisions" title="Link to this heading">#</a></h1>
<p>A comprehensive system for smart data collection and processing in cryo-electron microscopy, designed to optimize acquisition workflows through intelligent decision-making and real-time data analysis.</p>
<section id="system-components">
<h2>System Components<a class="headerlink" href="#system-components" title="Link to this heading">#</a></h2>
<ul class="simple">
<li><p><strong><code class="docutils literal notranslate"><span class="pre">smartem_common</span></code></strong>: Shared schemas, types, and utilities used across all components</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">smartem_api</span></code></strong>: HTTP API client and server functionality for component communication</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">smartem_backend</span></code></strong>: Core backend service with database operations and message queue processing</p></li>
<li><p><strong><code class="docutils literal notranslate"><span class="pre">smartem_agent</span></code></strong>: Data collection agent that monitors EPU output and communicates with backend</p></li>
<li><p>Project board: <a class="github reference external" href="https://github.com/orgs/DiamondLightSource/projects/33/views/1">DiamondLightSource/projects#33</a></p></li>
<li><p>Test Datasets: https://gitlab.diamond.ac.uk/scisoft/cryoem/smartem-decisions-test-datasets</p></li>
</ul>
<div class="pst-scrollable-table-container"><table class="table">
<thead>
<tr class="row-odd"><th class="head text-center"><p>Source</p></th>
<th class="head text-center"><p><a class="github reference external" href="https://github.com/DiamondLightSource/smartem-decisions">DiamondLightSource/smartem-decisions</a></p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-center"><p>Docker</p></td>
<td class="text-center"><p><code class="docutils literal notranslate"><span class="pre">docker</span> <span class="pre">run</span> <span class="pre">ghcr.io/DiamondLightSource/smartem-backend:latest</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-center"><p>Documentation</p></td>
<td class="text-center"><p><a class="reference external" href="https://DiamondLightSource.github.io/smartem-decisions">https://DiamondLightSource.github.io/smartem-decisions</a></p></td>
</tr>
<tr class="row-even"><td class="text-center"><p>Releases</p></td>
<td class="text-center"><p><a class="github reference external" href="https://github.com/DiamondLightSource/smartem-decisions/releases">DiamondLightSource/smartem-decisions</a></p></td>
</tr>
</tbody>
</table>
</div>
</section>
<section id="quick-start">
<h2>Quick Start<a class="headerlink" href="#quick-start" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">smartem_backend._version</span><span class="w"> </span><span class="kn">import</span> <span class="n">__version__</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Hello smartem_backend </span><span class="si">{</span><span class="n">__version__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="architecture-overview">
<h2>Architecture Overview<a class="headerlink" href="#architecture-overview" title="Link to this heading">#</a></h2>
<div class="highlight-mermaid notranslate"><div class="highlight"><pre><span></span> graph TD
    subgraph k8s[&quot;Kubernetes Cluster (Scientific Compute)&quot;]
        subgraph core[&quot;Core Services&quot;]
            api[&quot;SmartEM Core Service &amp; API&quot;]
            dp[&quot;Data Processing Pipeline &amp; ML Services&quot;]
        end

        subgraph infrastructure[&quot;Infrastructure Components&quot;]
            log[&quot;Logging Backend (Graylog)&quot;]
            db[(&quot;Persistent App State (PostgreSQL)&quot;)]
            mq[(&quot;Event Broker\n(RabbitMQ)&quot;)]
        end
    end

    subgraph ext[&quot;Acquisition Systems (external)&quot;]
        direction TB
        em[&quot;Electron Microscope (ThermoFisher)&quot;]
        gpfs[(&quot;GPFS&quot;)]
        epu[&quot;EPU Workstation (Windows with cygwin)&quot;]
        athena[&quot;Athena HTTP API Server&quot;]
    end

    %% Internal connections
    api --&gt; db
    api --&gt; mq
    dp --&gt; mq
    api --&gt; log

    %% External connections
    em --&gt; epu
    epu --&gt; gpfs
    epu --&gt; athena
    api --&gt; athena
    epu --&gt; api

    %% Styling
    classDef k8s fill:#e6f3ff,stroke:#666
    classDef core fill:#f9f9f9,stroke:#666
    classDef infra fill:#f5f5f5,stroke:#666
    classDef ext fill:#fff5e6,stroke:#666

    class k8s k8s
    class core core
    class infrastructure infra
    class ext ext
    %% Link styling
    linkStyle 0,1,2,3,4,5,6,7,8 stroke:#666
</pre></div>
</div>
</section>
<section id="development-setup">
<h2>Development Setup<a class="headerlink" href="#development-setup" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># venv and requirements</span>
python<span class="w"> </span>-m<span class="w"> </span>venv<span class="w"> </span>.venv
<span class="nb">source</span><span class="w"> </span>.venv/bin/activate
pip<span class="w"> </span>install<span class="w"> </span>-e<span class="w"> </span>.<span class="o">[</span>dev<span class="o">]</span><span class="w"> </span><span class="c1"># or .[backend] for production</span>

<span class="c1"># Start services with verbosity controls:</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api<span class="w"> </span>-v<span class="w">               </span><span class="c1"># HTTP API with INFO logging</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.consumer<span class="w"> </span>-v<span class="w">           </span><span class="c1"># Message queue consumer with INFO logging  </span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>watch<span class="w"> </span>/path/to/data<span class="w"> </span>-v<span class="w">     </span><span class="c1"># File watcher with INFO logging</span>

<span class="c1"># For testing file watcher with simulated EPU data:</span>
python<span class="w"> </span>tools/fsrecorder/fsrecorder.py<span class="w"> </span>replay<span class="w"> </span>recording.tar.gz<span class="w"> </span>/path/to/data<span class="w"> </span>--fast
</pre></div>
</div>
</section>
<section id="verbosity-control">
<h2>Verbosity Control<a class="headerlink" href="#verbosity-control" title="Link to this heading">#</a></h2>
<p>All SmartEM Backend services support configurable logging levels to help with debugging and reduce noise in production environments.</p>
<section id="command-line-verbosity">
<h3>Command Line Verbosity<a class="headerlink" href="#command-line-verbosity" title="Link to this heading">#</a></h3>
<p>Use the <code class="docutils literal notranslate"><span class="pre">-v</span></code> and <code class="docutils literal notranslate"><span class="pre">-vv</span></code> flags to control verbosity:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># ERROR level only (default - minimal output)</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.consumer
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api
python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>watch<span class="w"> </span>/path/to/data

<span class="c1"># INFO level and above (-v flag)</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.consumer<span class="w"> </span>-v
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api<span class="w"> </span>-v
python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>watch<span class="w"> </span>/path/to/data<span class="w"> </span>-v

<span class="c1"># DEBUG level and above (-vv flag - most verbose)</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.consumer<span class="w"> </span>-vv
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api<span class="w"> </span>-vv
python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>watch<span class="w"> </span>/path/to/data<span class="w"> </span>-vv
</pre></div>
</div>
</section>
<section id="environment-variable-control">
<h3>Environment Variable Control<a class="headerlink" href="#environment-variable-control" title="Link to this heading">#</a></h3>
<p>For the HTTP API, you can also control logging via environment variables:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set log level via environment variable (equivalent to -v/-vv flags)</span>
<span class="nv">SMARTEM_LOG_LEVEL</span><span class="o">=</span>ERROR<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api
<span class="nv">SMARTEM_LOG_LEVEL</span><span class="o">=</span>INFO<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api<span class="w"> </span>
<span class="nv">SMARTEM_LOG_LEVEL</span><span class="o">=</span>DEBUG<span class="w"> </span>python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api
</pre></div>
</div>
</section>
<section id="log-levels">
<h3>Log Levels<a class="headerlink" href="#log-levels" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p><strong>ERROR</strong> (default): Only critical errors are shown</p></li>
<li><p><strong>INFO</strong> (<code class="docutils literal notranslate"><span class="pre">-v</span></code>): Informational messages, warnings, and errors</p></li>
<li><p><strong>DEBUG</strong> (<code class="docutils literal notranslate"><span class="pre">-vv</span></code>): All messages including detailed debugging information</p></li>
</ul>
<p>This verbosity control helps reduce log noise during normal operation while providing detailed output when troubleshooting issues.</p>
</section>
</section>
</section>
<hr class="docutils" />
<section id="smartem-backend-module">
<h1>SmartEM Backend Module<a class="headerlink" href="#smartem-backend-module" title="Link to this heading">#</a></h1>
<p>The core backend service providing HTTP API, database operations, and message queue processing for intelligent cryo-EM data collection.</p>
<section id="backend-operations">
<h2>Backend Operations<a class="headerlink" href="#backend-operations" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># create env and launch service stack locally:</span>
./tools/dev-k8s.sh<span class="w"> </span>up

<span class="c1"># launch RabbitMQ worker (consumer)</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.consumer<span class="w">              </span><span class="c1"># ERROR level (default)</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.consumer<span class="w"> </span>-v<span class="w">           </span><span class="c1"># INFO level  </span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.consumer<span class="w"> </span>-vv<span class="w">          </span><span class="c1"># DEBUG level</span>

<span class="c1"># simulating an system event: </span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.simulate_msg<span class="w"> </span>--help<span class="w"> </span><span class="c1"># to see a list of options</span>
./tools/simulate-messages.sh<span class="w"> </span><span class="c1"># run a simulation, triggering system events in sequence</span>

<span class="c1"># run HTTP API with verbosity controls:</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api<span class="w">                  </span><span class="c1"># ERROR level (default)</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api<span class="w"> </span>-v<span class="w">               </span><span class="c1"># INFO level</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_backend.run_api<span class="w"> </span>-vv<span class="w">              </span><span class="c1"># DEBUG level</span>

<span class="c1"># run HTTP API in development (FastAPI CLI):</span>
fastapi<span class="w"> </span>dev<span class="w"> </span>src/smartem_backend/http_api.py<span class="w"> </span><span class="c1"># Note: FastAPI CLI gets installed by pip as one of dev dependencies</span>
<span class="c1"># run HTTP API in production (traditional):</span>
<span class="nb">source</span><span class="w"> </span>.env<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>uvicorn<span class="w"> </span>src.smartem_backend.http_api:app<span class="w"> </span>--host<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span>--port<span class="w"> </span><span class="nv">$HTTP_API_PORT</span>
<span class="c1"># run HTTP API with environment variable:</span>
<span class="nv">SMARTEM_LOG_LEVEL</span><span class="o">=</span>ERROR<span class="w"> </span>uvicorn<span class="w"> </span>src.smartem_backend.http_api:app<span class="w"> </span>--host<span class="w"> </span><span class="m">0</span>.0.0.0<span class="w"> </span>--port<span class="w"> </span><span class="nv">$HTTP_API_PORT</span>
<span class="c1"># smoke test the API:</span>
./tests/check_smartem_core_http_api.py<span class="w"> </span>http://localhost:8000<span class="w"> </span>-v

python<span class="w"> </span>-m<span class="w"> </span>smartem_backend<span class="w"> </span>--version
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="smartem-agent-epu-agent">
<h1>SmartEM Agent (EPU Agent)<a class="headerlink" href="#smartem-agent-epu-agent" title="Link to this heading">#</a></h1>
<p>The data collection agent that monitors EPU output directories and communicates acquisition data to the backend service.</p>
<p>The EPU agent runs on EPU workstations either as a Python script or bundled Windows binary. EPU workstations are Windows machines isolated from the main network, where specific connectivity is achieved through a proxy and configured via an allow-list. The primary purpose of the EPU agent is to parse EPU software output from the filesystem and communicate data and events to the core backend component.</p>
<p>An EPU data directory is generated by closed-source EPU software and represents an acquisition session using a cryo-electron microscope. The agent can:</p>
<ul class="simple">
<li><p>Parse data out of specific types of files typically found in EPU directories</p></li>
<li><p>Validate a finished EPU directory for correct structure and completeness</p></li>
<li><p>Parse out complete acquisition dataset from a finished EPU directory</p></li>
<li><p>Parse out incomplete acquisition dataset from an unfinished EPU directory</p></li>
<li><p>Run in filesystem watcher mode to incrementally update the acquisition dataset as EPU directory is written to</p></li>
<li><p>Run in <strong>default mode</strong> - combining the above to make it safe starting the data intake at any point in relation to EPU execution</p></li>
</ul>
<section id="agent-parse-and-validate-operations">
<h2>Agent Parse and Validate Operations<a class="headerlink" href="#agent-parse-and-validate-operations" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># parse complete EPU directory</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>dir<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/metadata_Supervisor_20250108_101446_62_cm40593-1_EPU

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>dir<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/metadata_Supervisor_20250114_220855_23_epuBSAd20_GrOxDDM

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>dir<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/metadata_Supervisor_20241220_140307_72_et2_gangshun

<span class="c1"># parse things</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>session<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/Supervisor_20250129_134723_36_bi37708-28_grid7_EPU/EpuSession.dm

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>atlas<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/atlas/Supervisor_20250129_111544_bi37708-28_atlas/Atlas/Atlas.dm

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>gridsquare<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/epu-Supervisor_20250404_164354_31_EPU_nr27313-442/metadata_Supervisor_20250404_164354_31_EPU_nr27313-442/Images-Disc1/GridSquare_3568837/GridSquare_20250404_171012.xml

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>gridsquare-metadata<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/epu-Supervisor_20250404_164354_31_EPU_nr27313-442/metadata_Supervisor_20250404_164354_31_EPU_nr27313-442/Metadata/GridSquare_3568837.dm

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>gridsquare-metadata<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>./tests/testdata/bi37708-28/Supervisor_20250129_134723_36_bi37708-28_grid7_EPU/Metadata/GridSquare_29273435.dm

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>foilhole<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>tests/testdata/epu-dir-example/Images-Disc1/GridSquare_8999138/FoilHoles/FoilHole_9015889_20250108_154725.xml

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>parse<span class="w"> </span>gridsquare-metadata<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/epu-Supervisor_20250404_164354_31_EPU_nr27313-442/metadata_Supervisor_20250404_164354_31_EPU_nr27313-442/Images-Disc1/GridSquare_3568837/Data/FoilHole_3595930_Data_3590445_56_20250405_084025.xml

<span class="c1"># Validate epu project dirs (expect failure):</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>validate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/Supervisor_20250129_114842_73_bi37708-28_grid7_EPU

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>validate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/Supervisor_20250130_105058_11

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>validate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/Supervisor_20250130_145409_68

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>validate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/Supervisor_20250130_150924_1grid3

<span class="c1"># Validate epu project dirs (expect success):</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>validate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/Supervisor_20250129_134723_36_bi37708-28_grid7_EPU

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>validate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/Supervisor_20250130_133418_68apoferritin

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>validate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/Supervisor_20250130_143856_44Practice

python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>validate<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/bi37708-28-copy/Supervisor_20250130_145409_68practice2
</pre></div>
</div>
</section>
<section id="agent-watch-operations">
<h2>Agent Watch Operations<a class="headerlink" href="#agent-watch-operations" title="Link to this heading">#</a></h2>
<p>The agent monitors EPU output directories for changes:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Launch the watcher:</span>
python<span class="w"> </span>-m<span class="w"> </span>smartem_agent<span class="w"> </span>watch<span class="w"> </span>../test-dir<span class="w"> </span>--log-file<span class="w"> </span>output.log

<span class="c1"># For testing incremental file writes, use the fsrecorder tool to simulate EPU behavior:</span>
<span class="c1"># First, record from an existing EPU dataset:</span>
python<span class="w"> </span>tools/fsrecorder/fsrecorder.py<span class="w"> </span>record<span class="w"> </span>../smartem-decisions-test-datasets/epu-Supervisor_20250326_145351_30_nt33824-10_grid2_1in5dil<span class="w"> </span>../test-recording.tar.gz

<span class="c1"># Then replay it to your test directory with accelerated timing:</span>
python<span class="w"> </span>tools/fsrecorder/fsrecorder.py<span class="w"> </span>replay<span class="w"> </span>../test-recording.tar.gz<span class="w"> </span>../test-dir<span class="w"> </span>--fast

<span class="c1"># Alternatively, for quick testing, copy data manually:</span>
cp<span class="w"> </span>-r<span class="w"> </span><span class="s2">&quot;../smartem-decisions-test-datasets/epu-Supervisor_20250326_145351_30_nt33824-10_grid2_1in5dil/&quot;</span>*<span class="w"> </span>../test-dir/
</pre></div>
</div>
<blockquote>
<div><p><strong>Note</strong>: The fsrecorder tool (<code class="docutils literal notranslate"><span class="pre">tools/fsrecorder/</span></code>) provides accurate simulation of EPU file writing patterns with proper timing and ordering.
The absence of <code class="docutils literal notranslate"><span class="pre">EpuSession.dm</span></code> file is pretty much a show-stopper as it provides references to atlas and is a trigger
for instantiating a new grid entity in the internal datastore.</p>
</div></blockquote>
<p>A <code class="docutils literal notranslate"><span class="pre">watch</span></code> operation is designed to gracefully handle one of the following invocation scenarios:</p>
<ol class="arabic simple">
<li><p>watcher launched <em>before</em> EPU starts writing to filesystem - only watcher is necessary</p></li>
<li><p>watcher launched <em>after</em> EPU starts writing to filesystem - both parser and watcher are
necessary to pickup pre-existing and new writes</p></li>
<li><p>watcher launched <em>after</em> EPU <em>finishes</em> writing to filesystem - only parser is necessary</p></li>
</ol>
</section>
<section id="epu-output-directory-structure">
<h2>EPU Output Directory Structure<a class="headerlink" href="#epu-output-directory-structure" title="Link to this heading">#</a></h2>
<blockquote>
<div><p>Directory layout on the EPU machine will differ from the layout of that
same directory synced to file storage. Layout relevant to epu data intake component
is as it appears on the EPU machines, where the watcher runs.</p>
</div></blockquote>
<p>In a user visit there can be more than one <code class="docutils literal notranslate"><span class="pre">EpuSession.dm</span></code> and more than one “project dir”
as there will be one for each grid. We usually treat each <code class="docutils literal notranslate"><span class="pre">EpuSession.dm</span></code> independently,
but they all connect to the same atlas.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>grid-data-dir-structure-example
├── EpuSession.dm
├── Images-Disc1
│  ├── GridSquare_8999138
│  │  ├── Data
│  │  │  ├── FoilHole_9015883_Data_9017347_6_20250108_154915.jpg
│  │  │  ├── FoilHole_9015883_Data_9017347_6_20250108_154915.xml
│  │  │  ├── FoilHole_9015883_Data_9017354_6_20250108_154918.jpg
│  │  │  └── FoilHole_9015883_Data_9017354_6_20250108_154918.xml
│  │  ├── FoilHoles
│  │  │  ├── FoilHole_9015889_20250108_154715.jpg
│  │  │  ├── FoilHole_9015889_20250108_154715.xml
│  │  │  ├── FoilHole_9015889_20250108_154725.jpg
│  │  │  └── FoilHole_9015889_20250108_154725.xml
│  │  ├── GridSquare_20250108_151151.jpg
│  │  └── GridSquare_20250108_151151.xml
│  └── GridSquare_8999186
│      ├── Data
│      │  ├── FoilHole_9028219_Data_9017347_50_20250109_062621.jpg
│      │  ├── FoilHole_9028219_Data_9017347_50_20250109_062621.xml
│      │  ├── FoilHole_9028219_Data_9017354_50_20250109_062624.jpg
│      │  └── FoilHole_9028219_Data_9017354_50_20250109_062624.xml
│      ├── FoilHoles
│      │  ├── FoilHole_9028276_20250109_061712.jpg
│      │  ├── FoilHole_9028276_20250109_061712.xml
│      │  ├── FoilHole_9028276_20250109_061722.jpg
│      │  ├── FoilHole_9028276_20250109_061722.xml
│      │  └── FoilHole_9028325_20250109_063110.jpg
│      ├── GridSquare_20250108_152955.jpg
│      └── GridSquare_20250108_152955.xml
└── Metadata
    ├── GridSquare_8999138.dm
    └── GridSquare_8999186.dm
</pre></div>
</div>
<section id="epu-directory-structure-details">
<h3>EPU Directory Structure Details<a class="headerlink" href="#epu-directory-structure-details" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>An EPU directory consists of multiple subdirectories as well as <code class="docutils literal notranslate"><span class="pre">.xml</span></code>, <code class="docutils literal notranslate"><span class="pre">.dm</span></code> and <code class="docutils literal notranslate"><span class="pre">.jpg</span></code> files</p>
<ul>
<li><p>Any <code class="docutils literal notranslate"><span class="pre">.dm</span></code> files are actually XML files</p></li>
<li><p>This directory is written to incrementally by EPU software, it does not materialise in a complete state right away</p></li>
</ul>
</li>
<li><p>An EPU directory will contain a file named <code class="docutils literal notranslate"><span class="pre">EpuSession.dm</span></code> at root level. Useful information contained in this file:</p>
<ul>
<li><p>Session <em>name</em>, <em>id</em> and <em>start time</em>;</p></li>
<li><p>fs path of the EPU directory;</p></li>
<li><p>A reference to <code class="docutils literal notranslate"><span class="pre">Atlas.dm</span></code> file (which resides outside the EPU directory);</p></li>
<li><p><em>clustering</em> mode and radius</p></li>
</ul>
</li>
<li><p>An <code class="docutils literal notranslate"><span class="pre">Atlas.dm</span></code> file contains general information about the acquisition session (which possibly duplicates info already
found in <code class="docutils literal notranslate"><span class="pre">EpuSession.dm</span></code> and, crucially, information about <em>atlas tiles</em></p>
<ul>
<li><p><em>Atlas tiles</em> contain positioning information, which is needed to map physical positions on the grid (measured in
number of turns of the actuator) to their pixel coordinates in image files</p></li>
</ul>
</li>
<li><p>An EPU directory will contain a subdirectory named <code class="docutils literal notranslate"><span class="pre">Metadata/</span></code> at root level</p>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">Metadata</span></code> directory is flat and contains a large list of files all using a naming convention
<code class="docutils literal notranslate"><span class="pre">GridSquare_&lt;gridsquare_id&gt;.dm</span></code>, for example: <code class="docutils literal notranslate"><span class="pre">GridSquare_8999138.dm</span></code>, <code class="docutils literal notranslate"><span class="pre">GridSquare_8999186.dm</span></code></p></li>
<li><p>The <code class="docutils literal notranslate"><span class="pre">Metadata/</span></code> directory contains all grid squares not just the ones that are captured</p></li>
<li><p>Some <code class="docutils literal notranslate"><span class="pre">Metadata/GridSquare_&lt;gridsquare_id&gt;.dm</span></code> files will have a significantly larger file size than others.
Those are the ones that were of interest and so further scans took place during the acquisition session</p></li>
<li><p>The rest of GridSquare files under <code class="docutils literal notranslate"><span class="pre">Metadata/</span></code> are typically around 2.8Kb in size</p></li>
</ul>
</li>
<li><p>An EPU directory contains at least one subdirectory named <code class="docutils literal notranslate"><span class="pre">Images-Disc1/</span></code> at root level,
and it’s possible to have multiple subdirectories with a naming convention <code class="docutils literal notranslate"><span class="pre">Images-Disc&lt;int&gt;</span></code>, though in most
cases there will only be one.</p>
<ul>
<li><p>An <code class="docutils literal notranslate"><span class="pre">Images-Disc&lt;int&gt;/</span></code> directory will contain a number of subdirectories following a naming convention
<code class="docutils literal notranslate"><span class="pre">GridSquare_&lt;gridsquare_id&gt;/</span></code>, corresponding to GridSquare files in <code class="docutils literal notranslate"><span class="pre">Metadata/</span></code>, but only for GridSquares of
interest where further scanning took place</p></li>
</ul>
</li>
<li><p>A GridSquare directory matching a glob <code class="docutils literal notranslate"><span class="pre">Images-Disc&lt;int&gt;/GridSquare_&lt;gridsquare_id&gt;/</span></code> will contain:</p>
<ul>
<li><p>a GridSquare manifest file, such as <code class="docutils literal notranslate"><span class="pre">GridSquare_20250108_152955.xml</span></code></p></li>
<li><p><strong>optionally</strong> subdirectories <code class="docutils literal notranslate"><span class="pre">FoilHoles/</span></code> and <code class="docutils literal notranslate"><span class="pre">Data/</span></code>, containing FoilHole and Micrograph information, respectively</p></li>
</ul>
</li>
</ul>
</section>
</section>
</section>
<hr class="docutils" />
<section id="kubernetes-deployment">
<h1>Kubernetes Deployment<a class="headerlink" href="#kubernetes-deployment" title="Link to this heading">#</a></h1>
<p>This directory contains Kubernetes deployment configurations for SmartEM Backend across different environments.</p>
<section id="quick-start-development">
<h2>Quick Start (Development)<a class="headerlink" href="#quick-start-development" title="Link to this heading">#</a></h2>
<p>For local development, use the convenient script that provides a docker-compose-like experience:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Start the development environment (equivalent to docker-compose up -d)</span>
./tools/dev-k8s.sh

<span class="c1"># Check status (equivalent to docker ps)</span>
./tools/dev-k8s.sh<span class="w"> </span>status

<span class="c1"># View logs for a service</span>
./tools/dev-k8s.sh<span class="w"> </span>logs<span class="w"> </span>smartem-http-api

<span class="c1"># Stop the environment (equivalent to docker-compose down)</span>
./tools/dev-k8s.sh<span class="w"> </span>down

<span class="c1"># Restart everything</span>
./tools/dev-k8s.sh<span class="w"> </span>restart

<span class="c1"># Get help</span>
./tools/dev-k8s.sh<span class="w"> </span>--help
</pre></div>
</div>
<section id="access-urls">
<h3>Access URLs<a class="headerlink" href="#access-urls" title="Link to this heading">#</a></h3>
<p>Once the environment is running, you can access:</p>
<ul class="simple">
<li><p><strong>📊 Adminer (Database UI)</strong>: http://localhost:30808</p></li>
<li><p><strong>🐰 RabbitMQ Management</strong>: http://localhost:30673</p></li>
<li><p><strong>📡 SmartEM Backend HTTP API</strong>: http://localhost:30080/health</p></li>
<li><p><strong>📚 API Documentation</strong>: http://localhost:30080/docs</p></li>
</ul>
<blockquote>
<div><p><strong>Note</strong>: The script automatically handles GitHub Container Registry authentication and waits for all pods to be ready.</p>
</div></blockquote>
</section>
</section>
<section id="kubernetes-structure">
<h2>Kubernetes Structure<a class="headerlink" href="#kubernetes-structure" title="Link to this heading">#</a></h2>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>k8s/
├── environments/
│   ├── development/          # Local development (k3s)
│   ├── staging/             # Staging environment (pollux)
│   └── production/          # Production environment (argos?)
└── README.md
</pre></div>
</div>
<p>For detailed Kubernetes deployment instructions, environment configurations, and troubleshooting, see the <a class="reference internal" href="#k8s/"><span class="xref myst">k8s directory documentation</span></a>.</p>
</section>
</section>
<hr class="docutils" />
<section id="development-tools">
<h1>Development Tools<a class="headerlink" href="#development-tools" title="Link to this heading">#</a></h1>
<p>Collection of utility tools for development, testing, and maintenance.</p>
<section id="format-xml-to-make-it-readable-recursively">
<h2>Format XML to make it readable, recursively<a class="headerlink" href="#format-xml-to-make-it-readable-recursively" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># To reformat all `.xml` and `.dm` files in a given directory recursively, rewriting in-place</span>
<span class="c1"># from single-line to human-readable:</span>
python<span class="w"> </span>tools/format_xml.py<span class="w"> </span>&lt;some_dir&gt;<span class="w"> </span>-r

<span class="c1"># Multiple dirs:</span>
python<span class="w"> </span>tools/format_xml.py<span class="w"> </span>-r<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/metadata_Supervisor_20250114_220855_23_epuBSAd20_GrOxDDM<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/metadata_Supervisor_20241220_140307_72_et2_gangshun<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>../smartem-decisions-test-datasets/metadata_Supervisor_20250108_101446_62_cm40593-1_EPU

<span class="c1"># For more options see:</span>
python<span class="w"> </span>tools/format_xml.py<span class="w"> </span>--help
</pre></div>
</div>
</section>
<section id="find-all-foilhole-manifest-duplicates-in-a-directory-recursively">
<h2>Find all foilhole manifest duplicates in a directory, recursively<a class="headerlink" href="#find-all-foilhole-manifest-duplicates-in-a-directory-recursively" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="w"> </span>
tools/find_foilhole_duplicates.py<span class="w"> </span>--help
<span class="c1"># e.g.</span>
tools/find_foilhole_duplicates.py<span class="w"> </span>./tests/testdata/bi37708-28
</pre></div>
</div>
</section>
<section id="list-all-files-matching-glob-recursively-in-descending-order-by-file-size">
<h2>List all files matching glob recursively in descending order by file size:<a class="headerlink" href="#list-all-files-matching-glob-recursively-in-descending-order-by-file-size" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># To find </span>
rg<span class="w"> </span>--files<span class="w"> </span>-g<span class="w"> </span><span class="s1">&#39;GridSquare_*.dm&#39;</span><span class="w"> </span>./tests/testdata/bi37708-28<span class="w"> </span><span class="se">\</span>
<span class="w">  </span><span class="p">|</span><span class="w"> </span>xargs<span class="w"> </span>-d<span class="w"> </span><span class="s1">&#39;\n&#39;</span><span class="w"> </span>ls<span class="w"> </span>-lh<span class="w"> </span><span class="p">|</span><span class="w"> </span>sort<span class="w"> </span>-k5<span class="w"> </span>-rn<span class="w"> </span><span class="p">|</span><span class="w"> </span>awk<span class="w"> </span><span class="s1">&#39;{print $9, $5}&#39;</span>
</pre></div>
</div>
</section>
<section id="clean-up-test-datasets-to-reduce-file-size">
<h2>Clean up test datasets to reduce file size<a class="headerlink" href="#clean-up-test-datasets-to-reduce-file-size" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># recursively find all distinct file extensions in directory</span>
find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="p">|</span>
<span class="w">  </span>sed<span class="w"> </span>-E<span class="w"> </span><span class="s1">&#39;s/.*\.([^.]+)$/\1/&#39;</span><span class="w"> </span><span class="p">|</span>
<span class="w">  </span>grep<span class="w"> </span>-v<span class="w"> </span><span class="s2">&quot;/&quot;</span><span class="w"> </span><span class="p">|</span>
<span class="w">  </span>sort<span class="w"> </span><span class="p">|</span>
<span class="w">  </span>uniq<span class="w"> </span>-c<span class="w"> </span><span class="p">|</span>
<span class="w">  </span>sort<span class="w"> </span>-nr

<span class="c1"># recursively empty all jpg, png, mrc files:</span>
find<span class="w"> </span>.<span class="w"> </span>-type<span class="w"> </span>f<span class="w"> </span><span class="se">\(</span><span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.jpg&quot;</span><span class="w"> </span>-o<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.png&quot;</span><span class="w"> </span>-o<span class="w"> </span>-name<span class="w"> </span><span class="s2">&quot;*.mrc&quot;</span><span class="w"> </span><span class="se">\)</span><span class="w"> </span>-exec<span class="w"> </span>truncate<span class="w"> </span>-s<span class="w"> </span><span class="m">0</span><span class="w"> </span><span class="o">{}</span><span class="w"> </span><span class="se">\;</span>
</pre></div>
</div>
</section>
<section id="watch-dir-metrics-num-of-files-and-file-size-as-stuff-is-written-to-it">
<h2>Watch dir metrics (num of files and file size) as stuff is written to it<a class="headerlink" href="#watch-dir-metrics-num-of-files-and-file-size-as-stuff-is-written-to-it" title="Link to this heading">#</a></h2>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>watch<span class="w"> </span>-n<span class="w"> </span><span class="m">1</span><span class="w"> </span><span class="s1">&#39;echo &quot;Size: $(du -sh .)&quot;; echo &quot;Files: $(find . -type f | wc -l)&quot;&#39;</span>
</pre></div>
</div>
</section>
</section>
<hr class="docutils" />
<section id="documentation-generation">
<h1>Documentation Generation<a class="headerlink" href="#documentation-generation" title="Link to this heading">#</a></h1>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span>tox<span class="w"> </span>-e<span class="w"> </span>docs
python<span class="w"> </span>-m<span class="w"> </span>http.server<span class="w"> </span>-d<span class="w"> </span>build/html
</pre></div>
</div>
</section>
<section id="containerization">
<h1>Containerization<a class="headerlink" href="#containerization" title="Link to this heading">#</a></h1>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># podman image/container operations:</span>
podman<span class="w"> </span>build<span class="w"> </span>--format<span class="w"> </span>docker<span class="w"> </span>.<span class="w"> </span>-t<span class="w"> </span>smartem_backend<span class="w"> </span><span class="c1"># build image</span>
podman<span class="w"> </span>run<span class="w"> </span>-p<span class="w"> </span><span class="m">8000</span>:8000<span class="w"> </span>localhost/smartem_backend<span class="w"> </span><span class="c1"># run container (TODO debug Postgres connection)</span>
podman<span class="w"> </span>image<span class="w"> </span>rm<span class="w"> </span>localhost/smartem_backend<span class="w"> </span>-f<span class="w"> </span><span class="c1"># clean up before rebuild</span>

<span class="c1"># TODO but we should push to Github not Gitlab</span>
<span class="c1"># Once built, tagging and pushing is done like so:</span>
<span class="c1"># Refs:</span>
<span class="c1">#  - https://confluence.diamond.ac.uk/display/CLOUD/Container+Registry</span>
<span class="c1">#  - https://dev-portal.diamond.ac.uk/guide/kubernetes/tutorials/containers/</span>
podman<span class="w"> </span>tag<span class="w"> </span>55646974a136<span class="w"> </span>gcr.io/diamond-pubreg/smartem_backend/smartem_backend:latest
podman<span class="w"> </span>push<span class="w"> </span>gcr.io/diamond-pubreg/smartem_backend/smartem_backend:latest
</pre></div>
</div>
</section>
<section id="technical-notes">
<h1>Technical Notes<a class="headerlink" href="#technical-notes" title="Link to this heading">#</a></h1>
<blockquote>
<div><p>TODO recycle these to <code class="docutils literal notranslate"><span class="pre">docs/</span></code></p>
</div></blockquote>
<ul class="simple">
<li><p>The number of micrographs in a single foil hole will be typically between 4 and 10.</p></li>
<li><p>The total number of micrographs collected from a grid is normally 10-50k.</p></li>
<li><p>The number of particles picked is about 300 per micrograph.</p></li>
<li><p>About half of those are selected and half rejected</p></li>
<li><p>mock the decision-making stuff</p>
<ul>
<li><p>to be tackled separately</p></li>
<li><p>to be decoupled and modular, so we can easily swap out decision-making authorities in the future</p></li>
</ul>
</li>
<li><p>communicate decisions to cryoEM controller API (TBC naming!)</p></li>
<li><p>https://github.com/DiamondLightSource/ispyb-database is a database schema that stores information about
what is run, metadata, how many images, sample type etc.</p></li>
<li><p>for context:</p>
<ul>
<li><p>https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10910546/,
https://www.ncbi.nlm.nih.gov/pmc/articles/PMC10910546/pdf/d-80-00174.pdf</p></li>
<li><p>https://www.biorxiv.org/content/10.1101/2024.02.12.579963v1,
https://www.biorxiv.org/content/10.1101/2024.02.12.579963v1.full.pdf</p></li>
</ul>
</li>
<li><p>initially the process produces stuff on the filesystem similar to this example: <code class="docutils literal notranslate"><span class="pre">doc/metadata_spa_acquisition</span></code></p></li>
<li><p>parts of the current <strong>Data Processing Pipeline</strong>:</p>
<ul>
<li><p>particle picking service receives a JSON blob via RabitMQ, is given a path to an image, picks on that and produces
a list of coordinates of particles on that image:
https://github.com/DiamondLightSource/cryoem-services/blob/main/src/cryoemservices/services/cryolo.py</p></li>
<li><p>particle filtering service: https://github.com/DiamondLightSource/cryoem-services/blob/main/src/cryoemservices/services/select_particles.py</p></li>
</ul>
</li>
</ul>
<section id="how-the-documentation-is-structured">
<h2>How the documentation is structured<a class="headerlink" href="#how-the-documentation-is-structured" title="Link to this heading">#</a></h2>
<p>Documentation is split into <a class="reference external" href="https://diataxis.fr">four categories</a>, also accessible from links in the top bar.</p>
<!-- https://sphinx-design.readthedocs.io/en/latest/grids.html -->
<div class="sd-container-fluid sd-sphinx-override sd-mb-4 docutils">
<div class="sd-row sd-row-cols-2 sd-row-cols-xs-2 sd-row-cols-sm-2 sd-row-cols-md-2 sd-row-cols-lg-2 sd-g-4 sd-g-xs-4 sd-g-sm-4 sd-g-md-4 sd-g-lg-4 docutils">
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
<svg version="4.0.0.63c5cb3" width="2.0em" height="2.0em" class="sd-material-icon sd-material-icon-directions_walk" viewBox="0 0 24 24" aria-hidden="true"><path d="M0 0h24v24H0z" fill="none"></path><path d="M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7"></path></svg></div>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="tutorials/installation.html">Installation</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="sd-card-footer docutils">
<p class="sd-card-text">Tutorials for installation and typical usage. New users start here.</p>
</div>
</div>
</div>
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
<svg version="4.0.0.63c5cb3" width="2.0em" height="2.0em" class="sd-material-icon sd-material-icon-directions" viewBox="0 0 24 24" aria-hidden="true"><path d="M0 0h24v24H0z" fill="none"></path><path d="M21.71 11.29l-9-9c-.39-.39-1.02-.39-1.41 0l-9 9c-.39.39-.39 1.02 0 1.41l9 9c.39.39 1.02.39 1.41 0l9-9c.39-.38.39-1.01 0-1.41zM14 14.5V12h-4v3H8v-4c0-.55.45-1 1-1h5V7.5l3.5 3.5-3.5 3.5z"></path></svg></div>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="how-to.html">How-to Guides</a><ul>
<li class="toctree-l2"><a class="reference internal" href="how-to/contribute.html">Contribute to the project</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-to/run-container.html">Run in a container</a></li>
<li class="toctree-l2"><a class="reference internal" href="how-to/use-core-http-api-client.html">How to Use the SmartEM API Client</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="sd-card-footer docutils">
<p class="sd-card-text">Practical step-by-step guides for the more experienced user.</p>
</div>
</div>
</div>
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
<svg version="4.0.0.63c5cb3" width="2.0em" height="2.0em" class="sd-material-icon sd-material-icon-info" viewBox="0 0 24 24" aria-hidden="true"><path d="M0 0h24v24H0z" fill="none"></path><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg></div>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="explanations.html">Explanations</a><ul>
<li class="toctree-l2"><a class="reference internal" href="explanations/decisions.html">Architectural Decision Records</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="sd-card-footer docutils">
<p class="sd-card-text">Explanations of how it works and why it works that way.</p>
</div>
</div>
</div>
<div class="sd-col sd-d-flex-row docutils">
<div class="sd-card sd-sphinx-override sd-w-100 sd-shadow-sm docutils">
<div class="sd-card-body docutils">
<div class="sd-card-title sd-font-weight-bold docutils">
<svg version="4.0.0.63c5cb3" width="2.0em" height="2.0em" class="sd-material-icon sd-material-icon-menu_book" viewBox="0 0 24 24" aria-hidden="true"><g><rect fill="none" height="24" width="24"></rect></g><g><g></rect><g><path d="M21,5c-1.11-0.35-2.33-0.5-3.5-0.5c-1.95,0-4.05,0.4-5.5,1.5c-1.45-1.1-3.55-1.5-5.5-1.5S2.45,4.9,1,6v14.65 c0,0.25,0.25,0.5,0.5,0.5c0.1,0,0.15-0.05,0.25-0.05C3.1,20.45,5.05,20,6.5,20c1.95,0,4.05,0.4,5.5,1.5c1.35-0.85,3.8-1.5,5.5-1.5 c1.65,0,3.35,0.3,4.75,1.05c0.1,0.05,0.15,0.05,0.25,0.05c0.25,0,0.5-0.25,0.5-0.5V6C22.4,5.55,21.75,5.25,21,5z M21,18.5 c-1.1-0.35-2.3-0.5-3.5-0.5c-1.7,0-4.15,0.65-5.5,1.5V8c1.35-0.85,3.8-1.5,5.5-1.5c1.2,0,2.4,0.15,3.5,0.5V18.5z"></path><g><path d="M17.5,10.5c0.88,0,1.73,0.09,2.5,0.26V9.24C19.21,9.09,18.36,9,17.5,9c-1.7,0-3.24,0.29-4.5,0.83v1.66 C14.13,10.85,15.7,10.5,17.5,10.5z"></path><path d="M13,12.49v1.66c1.13-0.64,2.7-0.99,4.5-0.99c0.88,0,1.73,0.09,2.5,0.26V11.9c-0.79-0.15-1.64-0.24-2.5-0.24 C15.8,11.66,14.26,11.96,13,12.49z"></path><path d="M17.5,14.33c-1.7,0-3.24,0.29-4.5,0.83v1.66c1.13-0.64,2.7-0.99,4.5-0.99c0.88,0,1.73,0.09,2.5,0.26v-1.52 C19.21,14.41,18.36,14.33,17.5,14.33z"></path></g></g></g></svg></div>
<div class="toctree-wrapper compound">
<ul>
<li class="toctree-l1"><a class="reference internal" href="reference.html">Reference</a><ul>
<li class="toctree-l2"><a class="reference internal" href="_api/smartem_backend.html">API</a></li>
<li class="toctree-l2"><a class="reference internal" href="genindex.html">Index</a></li>
<li class="toctree-l2"><a class="reference external" href="https://github.com/DiamondLightSource/smartem-decisions/releases">Release Notes</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div class="sd-card-footer docutils">
<p class="sd-card-text">Technical reference material including APIs and release notes.</p>
</div>
</div>
</div>
</div>
</div>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer d-print-none">
                  
<div class="prev-next-area">
    <a class="right-next"
       href="tutorials.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Tutorials</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script defer src="_static/scripts/bootstrap.js?digest=8878045cc6db502f8baf"></script>
<script defer src="_static/scripts/pydata-sphinx-theme.js?digest=8878045cc6db502f8baf"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  <!-- # L10n: Setting the PST URL as an argument as this does not need to be localized -->
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.16.1.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>