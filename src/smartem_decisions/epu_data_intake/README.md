from src.smartem_decisions.epu_data_intake.parser import EpuSession

# EPU directory parsing and data intake

An EPU data directory is generated by closed-source EPU software and represents an acquisition session
using a cryo-electron microscope

## Quickies

```bash
# parse things
python src/smartem_decisions/epu_data_intake/fs_parser.py parse-epu-session \
  tests/testdata/epu-dir-example/EpuSession.dm

python src/smartem_decisions/epu_data_intake/fs_parser.py parse-atlas \
  tests/testdata/Atlas.dm

python src/smartem_decisions/epu_data_intake/fs_parser.py parse-gridsquare \
  tests/testdata/epu-dir-example/Images-Disc1/GridSquare_8999138/GridSquare_20250108_151151.xml

python src/smartem_decisions/epu_data_intake/fs_parser.py parse-foilhole \
  tests/testdata/epu-dir-example/Images-Disc1/GridSquare_8999138/FoilHoles/FoilHole_9015889_20250108_154725.xml

python src/smartem_decisions/epu_data_intake/fs_parser.py parse-micrograph \
  tests/testdata/epu-dir-example/Images-Disc1/GridSquare_8999138/Data/FoilHole_9015883_Data_9017354_6_20250108_154918.xml
  
# validate epu project dirs
python src/smartem_decisions/epu_data_intake/fs_parser.py validate-epu-dir \
  tests/testdata/bi37708-28/Supervisor_20250129_114842_73_bi37708-28_grid7_EPU

python src/smartem_decisions/epu_data_intake/fs_parser.py validate-epu-dir \
  tests/testdata/bi37708-28/Supervisor_20250129_134723_36_bi37708-28_grid7_EPU

python src/smartem_decisions/epu_data_intake/fs_parser.py validate-epu-dir \
  tests/testdata/bi37708-28/Supervisor_20250130_105058_11

python src/smartem_decisions/epu_data_intake/fs_parser.py validate-epu-dir \
  tests/testdata/bi37708-28/Supervisor_20250130_133418_68apoferritin

python src/smartem_decisions/epu_data_intake/fs_parser.py validate-epu-dir \
  tests/testdata/bi37708-28/Supervisor_20250130_143856_44Practice

python src/smartem_decisions/epu_data_intake/fs_parser.py validate-epu-dir \
  tests/testdata/bi37708-28/Supervisor_20250130_145409_68

python src/smartem_decisions/epu_data_intake/fs_parser.py validate-epu-dir \
  tests/testdata/bi37708-28/Supervisor_20250130_145409_68practice2

python src/smartem_decisions/epu_data_intake/fs_parser.py validate-epu-dir \
  tests/testdata/bi37708-28/Supervisor_20250130_150924_1grid3

```

## Directory structure

Directory layout on the EPU machine will differ from the layout of that
same directory synced to file storage. Layout relevant to the watched
is as it appears on the EPU machines, where the watcher runs.

In a user visit there can be more than one `EpuSession.dm` and more than one "project dir"
as there will be one for each grid. We usually treat each `EpuSession.dm` independently,
but they all connect to the same atlas.

Since an original project directory is impractically large, here's a representative
example for reference (can be found under `tests/testdata/epu-dir-example` in this repo):

```
$ tree tests/testdata/epu-dir-example
tests/testdata/epu-dir-example
├── EpuSession.dm
├── Images-Disc1
│  ├── GridSquare_8999138
│  │  ├── Data
│  │  │  ├── FoilHole_9015883_Data_9017347_6_20250108_154915.jpg
│  │  │  ├── FoilHole_9015883_Data_9017347_6_20250108_154915.xml
│  │  │  ├── FoilHole_9015883_Data_9017354_6_20250108_154918.jpg
│  │  │  └── FoilHole_9015883_Data_9017354_6_20250108_154918.xml
│  │  ├── FoilHoles
│  │  │  ├── FoilHole_9015889_20250108_154715.jpg
│  │  │  ├── FoilHole_9015889_20250108_154715.xml
│  │  │  ├── FoilHole_9015889_20250108_154725.jpg
│  │  │  └── FoilHole_9015889_20250108_154725.xml
│  │  ├── GridSquare_20250108_151151.jpg
│  │  └── GridSquare_20250108_151151.xml
│  └── GridSquare_8999186
│      ├── Data
│      │  ├── FoilHole_9028219_Data_9017347_50_20250109_062621.jpg
│      │  ├── FoilHole_9028219_Data_9017347_50_20250109_062621.xml
│      │  ├── FoilHole_9028219_Data_9017354_50_20250109_062624.jpg
│      │  └── FoilHole_9028219_Data_9017354_50_20250109_062624.xml
│      ├── FoilHoles
│      │  ├── FoilHole_9028276_20250109_061712.jpg
│      │  ├── FoilHole_9028276_20250109_061712.xml
│      │  ├── FoilHole_9028276_20250109_061722.jpg
│      │  ├── FoilHole_9028276_20250109_061722.xml
│      │  └── FoilHole_9028325_20250109_063110.jpg
│      ├── GridSquare_20250108_152955.jpg
│      └── GridSquare_20250108_152955.xml
└── Metadata
    ├── GridSquare_8999138.dm
    └── GridSquare_8999186.dm
```

- An EPU directory consists of multiple subdirectories as well as `.xml`, `.dm` and `.jpg` files
  - Any `.dm` files are actually XML files
  - This directory is written to incrementally by EPU software, it does not materialise in a complete state right away
- An EPU directory will contain a file named `EpuSession.dm` at root level. Useful information contained in this file:
  - Session _name_, _id_ and _start time_;
  - fs path of the EPU directory;
  - A reference to `Atlas.dm` file (which resides outside the EPU directory);
  - _clustering_ mode and radius
- An `Atlas.dm` file contains general information about the acquisition session (which possibly duplicates info already
  found in `EpuSession.dm` and, crucially, information about _atlas tiles_
  - _Atlas tiles_ contain positioning information, which is needed to map physical positions on the grid (measured in
    number of turns of the actuator) to their pixel coordinates in image files
  - An example of such file can be found under `tests/testdata/Atlas.dm`
- An EPU directory will contain a subdirectory named `Metadata/` at root level
  - `Metadata` directory is flat and contains a large list of files all using a naming convention
    `GridSquare_<gridsquare_id>.dm`, for example: `GridSquare_8999138.dm`, `GridSquare_8999186.dm`
  - The `Metadata/` directory contains all grid squares not just the ones that are captured
  - Some `Metadata/GridSquare_<gridsquare_id>.dm` files will have a significantly larger file size than others.
    Those are the ones that were of interest and so further scans took place during the acquisition session
  - The rest of GridSquare files under `Metadata/` are typically around 2.8Kb in size
- An EPU directory contains at least one subdirectory named `Images-Disc1/` at root level,
  and it's possible to have multiple subdirectories with a naming convention `Images-Disc<int>`, though in most
  cases there will only be one. 
  - An `Images-Disc<int>/` directory will contain a number of subdirectories following a naming convention
    `GridSquare_<gridsquare_id>/`, corresponding to GridSquare files in `Metadata/`, but only for GridSquares of
    interest where further scanning took place
- A GridSquare directory matching a glob `Images-Disc<int>/GridSquare_<gridsquare_id>/` will contain:
  - a GridSquare manifest file, such as `GridSquare_20250108_152955.xml`
  - **optionally** subdirectories `FoilHoles/` and `Data/`, containing FoilHole and Micrograph information, respectively


## Filesystem watcher

We need to watch the EPU output directory for changes, to that end:

```bash
# Launch the watcher:
rm -f -- output.log && rm -rf ../fs-watcher-test-dir/* && \
  python src/smartem_decisions/epu_data_intake/watcher.py ../fs-watcher-test-dir/ \
  --log-file output.log

# In another terminal launch a simulator that randomly writes to target dir:
python src/smartem_decisions/epu_data_intake/test_watcher.py ../fs-watcher-test-dir \
  -d 60 -i 3 \
  --template-dir tests/testdata/epu-dir-example
```

> Note there might be discrepancies between the kinds of filesystem events (e.g. "created", "modified", "closed")
> produced by a test script run on Linux vs what EPU software might produce on Windows. Needs to be confirmed


## Reformat XML to make it readable

```bash
# To reformat all `.xml` and `.dm` files in a given directory recursively, rewriting in-place
# from single-line to human-readable:
python src/smartem_decisions/epu_data_intake/format_xml.py <tests/testdata/some_dir> -r

# Multiple dirs:
python src/smartem_decisions/epu_data_intake/format_xml.py -r \
  ../metadata_Supervisor_20250114_220855_23_epuBSAd20_GrOxDDM \
  ../metadata_Supervisor_20241220_140307_72_et2_gangshun \
  ../metadata_Supervisor_20250108_101446_62_cm40593-1_EPU

# For more options see:
python src/smartem_decisions/epu_data_intake/format_xml.py --help
```
