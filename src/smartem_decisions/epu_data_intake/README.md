# EPU directory parsing and data intake

An EPU data directory is generated by closed-source EPU software and represents an acquisition session
using a cryo-electron microscope

## Directory structure

As the original directory containing a complete dataset is too large, I've created a representative example for
your reference:

```
$ tree tests/testdata/example
tests/testdata/example
├── EpuSession.dm
├── Images-Disc1
│  ├── GridSquare_8999138
│  │  ├── Data
│  │  │  ├── FoilHole_9015883_Data_9017347_6_20250108_154915.jpg
│  │  │  ├── FoilHole_9015883_Data_9017347_6_20250108_154915.xml
│  │  │  ├── FoilHole_9015883_Data_9017354_6_20250108_154918.jpg
│  │  │  └── FoilHole_9015883_Data_9017354_6_20250108_154918.xml
│  │  ├── FoilHoles
│  │  │  ├── FoilHole_9015889_20250108_154715.jpg
│  │  │  ├── FoilHole_9015889_20250108_154715.xml
│  │  │  ├── FoilHole_9015889_20250108_154725.jpg
│  │  │  └── FoilHole_9015889_20250108_154725.xml
│  │  ├── GridSquare_20250108_151151.jpg
│  │  └── GridSquare_20250108_151151.xml
│  └── GridSquare_8999186
│      ├── Data
│      │  ├── FoilHole_9028219_Data_9017347_50_20250109_062621.jpg
│      │  ├── FoilHole_9028219_Data_9017347_50_20250109_062621.xml
│      │  ├── FoilHole_9028219_Data_9017354_50_20250109_062624.jpg
│      │  └── FoilHole_9028219_Data_9017354_50_20250109_062624.xml
│      ├── FoilHoles
│      │  ├── FoilHole_9028276_20250109_061712.jpg
│      │  ├── FoilHole_9028276_20250109_061712.xml
│      │  ├── FoilHole_9028276_20250109_061722.jpg
│      │  ├── FoilHole_9028276_20250109_061722.xml
│      │  └── FoilHole_9028325_20250109_063110.jpg
│      ├── GridSquare_20250108_152955.jpg
│      └── GridSquare_20250108_152955.xml
└── Metadata
    ├── GridSquare_8999138.dm
    └── GridSquare_8999186.dm
```

- An EPU directory consists of multiple subdirectories as well as `.xml`, `.dm` and `.jpg` files
  - `.dm` files are actually XML files
  - You may ignore any `.jpg` files at any level of nesting at this time
- An EPU directory will contain a file named `EpuSession.dm` at root level, this will be the entrypoint for our parser
- An EPU directory will contain a subdirectory named `Metadata` at root level
  - `Metadata` directory is flat and contains a large list of files all using a naming convention
    `GridSquare_<gridsquare_id>.dm`, for example: `GridSquare_8999138.dm`, `GridSquare_8999186.dm`
  - Some metadata GridSquare files will have a significantly larger file size than others. Those are the ones
    that were of interest and so further scanned took place during the acquisition session.
  - The rest of GridSquare files under `Metadata/` will be around 2.8Kb in size
- An EPU directory will contain a subdirectory named `Images-Disc1` at root level, let's call it a "Disk Images Dir"
  - It's possible to multiple such subdirectories with a naming convention `Images-Disc<int>`, let's assume
    there might be up to a dozen.
  - An Images-Disc<int> directory will contain a number of subdirectories following a naming convention,
    `GridSquare_<gridsquare_id>`, corresponding to GridSquare files in `Metadata/`, but only for GridSquares of interest
    where further scanning took place. Let's call a directory under `Images-Disc<int>/GridSquare_<gridsquare_id>` a
    "GridSquare Data Dir"

## Parser script pseudocode

Define dataclasses for: `AcquisitionSession`, `GridSquare`, `FoilHole`
Accept path to `epu_data_dir`
Find `epu_data_dir/EpuSession.dm`, check exists, check is valid XML
Load session metadata from `EpuSession.dm`:
  - parse acquisition session metadata
    - `EpuSessionXml/Id`
    - `EpuSessionXml/Name`
    - `EpuSessionXml/StartDateTime`
  - session settings
    - `EpuSessionXml/AutoFocusEnabled`
    - `EpuSessionXml/AutoStageTimeEnabled`
    - `EpuSessionXml/AutoZeroLossEnabled`
    - `EpuSessionXml/AutoZeroLossPeriodicity`
    - `EpuSessionXml/AutoloaderSlot`
    - `EpuSessionXml/ClusteringMode`
    - `EpuSessionXml/ClusteringRadius`
    - `EpuSessionXml/DoseFractionsOutputFormat`
    - `EpuSessionXml/EnableSmartHoleSelection`
    - `EpuSessionXml/IceThicknessEnabled`
    - `EpuSessionXml/ImageFileFormat`
    - `EpuSessionXml/IsManuallySelected`
    - `EpuSessionXml/IsSmartFilterGridSquareDecisionKnown`
    - `TiltAngle`
    - `TiltedAcquisitionEnabled`
    - `EpuSessionXml/PhasePlateAccelerateEnabled`
    - `EpuSessionXml/PhasePlateActivationTime`
    - `EpuSessionXml/PhasePlateEnabled`
    - `EpuSessionXml/PhasePlatePeriodicity`
    - `EpuSessionXml/RemoveHolesCloseToGridBarOnAutomaticRun`
    - `EpuSessionXml/SkipGridSquareEnabled`
    - `EpuSessionXml/SmartFoilHoleFindingEnabled`
    - `EpuSessionXml/SmartGridSquareEnabled`
  - parse software version
    - `Version/a:_Major`
    - `Version/a:_Minor`
    - `Version/a:_Revision`
    - `Version/a:_Build`
  - **TODO** See what useful stuff can be extracted from `EpuSessionXml/Samples/_items`
- find all `Images-Disc<int>` directories 
- load total list of grid squares from `/Metadata` directory
- identify active grid squares by matching against contents of `Images-Disc<int>` dir
- parse useful data out of `Images-Disc<int>/GridSquare_<id>/GridSquare_<ts>.xml`
  - **TODO**
- **TODO** parse contents of `Images-Disc<int>/GridSquare_<id>/Data`
- **TODO** parse contents of `Images-Disc<int>/GridSquare_<id>/FoilHoles`
- **TODO** get list of foil holes and foil hole data
